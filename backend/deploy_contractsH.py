from eth_account import Account
import json
import web3
from web3 import Web3, HTTPProvider, IPCProvider
from web3.contract import ConciseContract
from time import sleep

#node_url = "https://rinkeby.infura.io/v3/bffbf6c2890e43358c8fa18187789fdb"
#provider_url = "wss://rinkeby.infura.io/ws/v3/bffbf6c2890e43358c8fa18187789fdb"
node_url = "https://rinkeby.infura.io/v3/6a3397d0a8394382a35037cadddfcafe"
provider_url = "wss://rinkeby.infura.io/ws/v3/6a3397d0a8394382a35037cadddfcafe"
privateKey = "0xbab478afa30c6777b38200c546aeebbe8489c39a3da1287efa7e9d7ed707352e"


def readAbi(fileName):
    f = open(fileName, "r")
    abi = json.loads(f.read())
    f.close()
    return abi


heater_bytecode = "60806040526000600160146101000a81548160ff0219169083151502179055506000600160156101000a81548160ff02191690831515021790555034801561004657600080fd5b50336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555061009561009b60201b60201c565b506101f3565b6000600160159054906101000a900460ff1615610120576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252600e8152602001807f456e64656420636f6e747261637400000000000000000000000000000000000081525060200191505060405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff16600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614156101805760009050610193565b61018e61019660201b60201c565b600190505b90565b600160149054906101000a900460ff166101f15760018060146101000a81548160ff0219169083151502179055507fb6b49146609ca7b82407ba2c0a14cf5a9e1bf0bee2f279aadf259fa97ad20dab60405160405180910390a15b565b610cc5806102026000396000f3fe608060405234801561001057600080fd5b50600436106100cf5760003560e01c8063a094a0311161008c578063bb40b22211610066578063bb40b2221461022e578063f2fde38b14610262578063f33218cf146102a6578063fa52edb0146102c6576100cf565b8063a094a031146101aa578063a4fd6f56146101ca578063a9623874146101ea576100cf565b806304fa03f7146100d45780631bfcc5cf14610104578063200d2ed214610134578063544736e6146101525780636e9288b81461017257806386ec6177146101a0575b600080fd5b610102600480360360208110156100ea57600080fd5b8101908080351515906020019092919050505061030a565b005b6101326004803603602081101561011a57600080fd5b81019080803515159060200190929190505050610441565b005b61013c610578565b6040518082815260200191505060405180910390f35b61015a61057e565b60405180821515815260200191505060405180910390f35b61019e6004803603602081101561018857600080fd5b8101908080359060200190929190505050610591565b005b6101a8610668565b005b6101b2610684565b60405180821515815260200191505060405180910390f35b6101d2610779565b60405180821515815260200191505060405180910390f35b6102166004803603602081101561020057600080fd5b810190808035906020019092919050505061078c565b60405180821515815260200191505060405180910390f35b6102366107ac565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6102a46004803603602081101561027857600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291905050506107d2565b005b6102ae610951565b60405180821515815260200191505060405180910390f35b610308600480360360208110156102dc57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610964565b005b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168073ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146103ce576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260138152602001807f41646472657373206e6f7420616c6c6f7765640000000000000000000000000081525060200191505060405180910390fd5b81600460006101000a81548160ff0219169083151502179055507f035a685ae71650e5d7cfbf064aecfe6a6f7acd74594cce6d8ff83207494f0778600460009054906101000a900460ff1660405180821515815260200191505060405180910390a161043d6307a9b4d2610a72565b5050565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168073ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610505576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260138152602001807f41646472657373206e6f7420616c6c6f7765640000000000000000000000000081525060200191505060405180910390fd5b81600460006101000a81548160ff0219169083151502179055507f035a685ae71650e5d7cfbf064aecfe6a6f7acd74594cce6d8ff83207494f0778600460009054906101000a900460ff1660405180821515815260200191505060405180910390a16105746307a9b4d2610a72565b5050565b60035481565b600160149054906101000a900460ff1681565b61059e6307a9b4d2610ad8565b610610576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252600b8152602001807f4e6f7420656e61626c656400000000000000000000000000000000000000000081525060200191505060405180910390fd5b61061d6307a9b4d2610b02565b806003819055507f46433c07253205c5fe01c35f94b7c25cb443ed57b1992106613ed6263542374f6003546040518082815260200191505060405180910390a1610665610b68565b50565b60018060156101000a81548160ff021916908315150217905550565b6000600160159054906101000a900460ff1615610709576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252600e8152602001807f456e64656420636f6e747261637400000000000000000000000000000000000081525060200191505060405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff16600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614156107695760009050610776565b610771610bf9565b600190505b90565b600160159054906101000a900460ff1681565b60026020528060005260406000206000915054906101000a900460ff1681565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610893576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260118152602001807f41646472657373206e6f742076616c696400000000000000000000000000000081525060200191505060405180910390fd5b61089c81610c56565b61090e576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260118152602001807f41646472657373206e6f742076616c696400000000000000000000000000000081525060200191505060405180910390fd5b806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b600460009054906101000a900460ff1681565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610a25576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260118152602001807f41646472657373206e6f742076616c696400000000000000000000000000000081525060200191505060405180910390fd5b80600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550610a6e610684565b5050565b60016002600083815260200190815260200160002060006101000a81548160ff0219169083151502179055507f062e0861d5487e926f5f2570e58d44c81580def7044c232ee0d939c4d2ba2259816040518082815260200191505060405180910390a150565b60006002600083815260200190815260200160002060009054906101000a900460ff169050919050565b60006002600083815260200190815260200160002060006101000a81548160ff0219169083151502179055507f470d577b826466531919b2b313ba7a913f56d9b6adcb14a1a20864553505ac5d816040518082815260200191505060405180910390a150565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663cbd7d6b96003546040518263ffffffff1660e01b815260040180828152602001915050600060405180830381600087803b158015610bdf57600080fd5b505af1158015610bf3573d6000803e3d6000fd5b50505050565b600160149054906101000a900460ff16610c545760018060146101000a81548160ff0219169083151502179055507fb6b49146609ca7b82407ba2c0a14cf5a9e1bf0bee2f279aadf259fa97ad20dab60405160405180910390a15b565b60008073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff161415905091905056fea2646970667358221220a4cce1c36f2abb4e79c0f63e8a116bb4307fc404efb20791655fe20433a826e764736f6c634300060c0033"
sensor_bytecode = "60806040526000600160146101000a81548160ff0219169083151502179055506000600160156101000a81548160ff02191690831515021790555034801561004657600080fd5b50336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555061009561009b60201b60201c565b506101f3565b6000600160159054906101000a900460ff1615610120576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252600e8152602001807f456e64656420636f6e747261637400000000000000000000000000000000000081525060200191505060405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff16600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614156101805760009050610193565b61018e61019660201b60201c565b600190505b90565b600160149054906101000a900460ff166101f15760018060146101000a81548160ff0219169083151502179055507fb6b49146609ca7b82407ba2c0a14cf5a9e1bf0bee2f279aadf259fa97ad20dab60405160405180910390a15b565b610c8c806102026000396000f3fe608060405234801561001057600080fd5b50600436106100ea5760003560e01c8063a4fd6f561161008c578063d1e485be11610066578063d1e485be14610255578063ed6050e51461025f578063f2fde38b14610269578063fa52edb0146102ad576100ea565b8063a4fd6f56146101bd578063a9623874146101dd578063bb40b22214610221576100ea565b806386ec6177116100c857806386ec61771461015b5780638cb15c7c146101655780639c3b861c1461016f578063a094a0311461019d576100ea565b80631e6b1df4146100ef578063544736e61461011d578063673402e51461013d575b600080fd5b61011b6004803603602081101561010557600080fd5b81019080803590602001909291905050506102f1565b005b610125610408565b60405180821515815260200191505060405180910390f35b61014561041b565b6040518082815260200191505060405180910390f35b610163610421565b005b61016d61043d565b005b61019b6004803603602081101561018557600080fd5b8101908080359060200190929190505050610468565b005b6101a5610577565b60405180821515815260200191505060405180910390f35b6101c561066c565b60405180821515815260200191505060405180910390f35b610209600480360360208110156101f357600080fd5b810190808035906020019092919050505061067f565b60405180821515815260200191505060405180910390f35b61022961069f565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b61025d6106c5565b005b6102676106f0565b005b6102ab6004803603602081101561027f57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061071b565b005b6102ef600480360360208110156102c357600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061089a565b005b61031a7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffc82119796109a8565b61038c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252600b8152602001807f4e6f7420656e61626c656400000000000000000000000000000000000000000081525060200191505060405180910390fd5b6103b57fffffffffffffffffffffffffffffffffffffffffffffffffffffffffc82119796109d2565b806003819055507f0b544df78d286e8b03fd9c67a0b16ae6f1b3b4292a0d44f73163dc6e49d0f1a96003546040518082815260200191505060405180910390a16103fd61043d565b610405610a38565b50565b600160149054906101000a900460ff1681565b60035481565b60018060156101000a81548160ff021916908315150217905550565b6104667fffffffffffffffffffffffffffffffffffffffffffffffffffffffffc82119796109d2565b565b6104917ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffdf8905c6109a8565b610503576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252600b8152602001807f4e6f7420656e61626c656400000000000000000000000000000000000000000081525060200191505060405180910390fd5b61052c7ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffdf8905c6109d2565b806003819055507f0b544df78d286e8b03fd9c67a0b16ae6f1b3b4292a0d44f73163dc6e49d0f1a96003546040518082815260200191505060405180910390a1610574610ac9565b50565b6000600160159054906101000a900460ff16156105fc576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252600e8152602001807f456e64656420636f6e747261637400000000000000000000000000000000000081525060200191505060405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff16600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16141561065c5760009050610669565b610664610b5a565b600190505b90565b600160159054906101000a900460ff1681565b60026020528060005260406000206000915054906101000a900460ff1681565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6106ee7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffc8211979610bb7565b565b6107197ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffdf8905c610bb7565b565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146107dc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260118152602001807f41646472657373206e6f742076616c696400000000000000000000000000000081525060200191505060405180910390fd5b6107e581610c1d565b610857576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260118152602001807f41646472657373206e6f742076616c696400000000000000000000000000000081525060200191505060405180910390fd5b806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461095b576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260118152602001807f41646472657373206e6f742076616c696400000000000000000000000000000081525060200191505060405180910390fd5b80600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506109a4610577565b5050565b60006002600083815260200190815260200160002060009054906101000a900460ff169050919050565b60006002600083815260200190815260200160002060006101000a81548160ff0219169083151502179055507f470d577b826466531919b2b313ba7a913f56d9b6adcb14a1a20864553505ac5d816040518082815260200191505060405180910390a150565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166376a83d2c6003546040518263ffffffff1660e01b815260040180828152602001915050600060405180830381600087803b158015610aaf57600080fd5b505af1158015610ac3573d6000803e3d6000fd5b50505050565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663a97d32c46003546040518263ffffffff1660e01b815260040180828152602001915050600060405180830381600087803b158015610b4057600080fd5b505af1158015610b54573d6000803e3d6000fd5b50505050565b600160149054906101000a900460ff16610bb55760018060146101000a81548160ff0219169083151502179055507fb6b49146609ca7b82407ba2c0a14cf5a9e1bf0bee2f279aadf259fa97ad20dab60405160405180910390a15b565b60016002600083815260200190815260200160002060006101000a81548160ff0219169083151502179055507f062e0861d5487e926f5f2570e58d44c81580def7044c232ee0d939c4d2ba2259816040518082815260200191505060405180910390a150565b60008073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff161415905091905056fea2646970667358221220512960251a0d6c83e9d1f77e9694e7f5927875c4f8aeeff2e3769d0052f2bd5664736f6c634300060c0033"

w3 = Web3(HTTPProvider(node_url))
web3 = Web3(Web3.WebsocketProvider(provider_url))
acct = w3.eth.account.privateKeyToAccount(privateKey)

def deployNewSensor(thermostatAddress):
    print("New sensor deploying...")
    contracts = w3.eth.contract(bytecode=sensor_bytecode, abi=readAbi("sensor.json"))
    return deploy(contracts, thermostatAddress)

def deployNewHeater(thermostatAddress):
    print("New heater deploying...")
    contract = w3.eth.contract(bytecode=heater_bytecode, abi=readAbi("heater.json"))
    return deploy(contract, thermostatAddress)

def deploy(contract, thermostatAddress):
    deploy_hash = contract.constructor().buildTransaction({
         'from': acct.address,
         'nonce': w3.eth.getTransactionCount(acct.address),
         'gas': 1728712,
         'gasPrice': w3.toWei('21', 'gwei')
         })
    signed = acct.signTransaction(deploy_hash)
    tx_hash = w3.eth.sendRawTransaction(signed.rawTransaction)
    print("Contract creation transaction : ", tx_hash.hex())
    tx_receipt = w3.eth.waitForTransactionReceipt(tx_hash)
    print("Contract created : ", tx_receipt['contractAddress'])
    initializeThermostatAddressTransaction(contract, tx_receipt['contractAddress'], Web3.toChecksumAddress(thermostatAddress))
    return tx_receipt['contractAddress']

def initializeTemperature(contract, temperature):
    tx = contract.functions.set_initializeTemp(temperature).buildTransaction({
        'nonce': w3.eth.getTransactionCount(acct.address),
        'from': acct.address,
    })
    signed_tx = w3.eth.account.signTransaction(tx, private_key=privateKey)
    tx_hash = w3.eth.sendRawTransaction(signed_tx.rawTransaction)
    print('Initialize temperature transaction : https://rinkeby.etherscan.io/tx/{0}'.format(tx_hash.hex()))
    tx_receipt = w3.eth.waitForTransactionReceipt(tx_hash)

def initializeThermostatAddressTransaction(contract, contractAddress, thermostatAddress):
    tx = contract.functions.initializeThermostatAddress(thermostatAddress).buildTransaction({
        'nonce': w3.eth.getTransactionCount(acct.address),
        'from': acct.address,
        'to': contractAddress
    })
    signed_tx = w3.eth.account.signTransaction(tx, private_key=privateKey)
    tx_hash = w3.eth.sendRawTransaction(signed_tx.rawTransaction)
    print('Initialize thermostat transaction : https://rinkeby.etherscan.io/tx/{0}'.format(tx_hash.hex()))
    tx_receipt = w3.eth.waitForTransactionReceipt(tx_hash)

def activationsCall(contract, functionId):
    return contract.functions.activations.(functionId).call    

def communicateStatus(contract, status):
    tx = contract.functions.set_communicateStatus(status).buildTransaction({
        'nonce': w3.eth.getTransactionCount(acct.address),
        'from': acct.address
    })
    signed_tx = w3.eth.account.signTransaction(tx, private_key=privateKey)
    tx_hash = w3.eth.sendRawTransaction(signed_tx.rawTransaction)
    print('Communicate status transaction : https://rinkeby.etherscan.io/tx/{0}'.format(tx_hash.hex()))
    tx_receipt = w3.eth.waitForTransactionReceipt(tx_hash)

def communicateTemperature(contract, temperature):
    tx = contract.functions.set_communicateTemp(temperature).buildTransaction({
        'nonce': w3.eth.getTransactionCount(acct.address),
        'from': acct.address
    })
    signed_tx = w3.eth.account.signTransaction(tx, private_key=privateKey)
    tx_hash = w3.eth.sendRawTransaction(signed_tx.rawTransaction)
    print('Communicate temperature transaction : https://rinkeby.etherscan.io/tx/{0}'.format(tx_hash.hex()))
    tx_receipt = w3.eth.waitForTransactionReceipt(tx_hash)

def heatCall(contract):
    return contract.functions.heat().call()